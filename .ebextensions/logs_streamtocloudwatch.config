option_settings:
    - namespace: aws:elasticbeanstalk:cloudwatch:logs
      option_name: StreamLogs
      value: true
    - namespace: aws:elasticbeanstalk:cloudwatch:logs
      option_name: DeleteOnTerminate
      value: false
    - namespace: aws:elasticbeanstalk:cloudwatch:logs
      option_name: RetentionInDays
      value: 7

packages:
    dnf:
        amazon-cloudwatch-agent: []

files:
    "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json":
        mode: "000600"
        owner: root
        group: root
        content: |
            {
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/app/current/storage/logs/laravel.log",
                        "log_group_name": "/aws/elasticbeanstalk/{{AWSEBEnvironmentName}}/var/app/current/storage/logs",
                        "log_stream_name": "{instance_id}",
                        "timestamp_format": "%Y-%m-%d %H:%M:%S"
                      }
                    ]
                  }
                }
              }
            }

commands:
    "01_install_cloudwatch_agent":
        command: dnf install -y amazon-cloudwatch-agent
    "02_configure_cloudwatch_agent":
        command: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
    "03_enable_cloudwatch_agent":
        command: systemctl enable amazon-cloudwatch-agent
    "04_start_cloudwatch_agent":
        command: systemctl start amazon-cloudwatch-agent
    "05_check_agent_status":
        command: systemctl status amazon-cloudwatch-agent >> /var/log/cw_agent_status.log
